machine:
  pre:
    - rm varys/.ruby-version
  ruby:
    version: 2.1.9
  services:
    - docker
dependencies:
  pre:
    - gem install bundle
    - bundle config path ~/bundle/
  cache_directories:
    - "~/bundle"
test:
  override:
    - bundle exec rubocop
    - bundle exec rake test
deployment:
  release:
    tag: /.*/
    commands:
      - $(aws ecr get-login --region us-east-1)
      - git reset --hard
      - docker build -t varys --build-arg exclude_gems='development test' .
      - docker tag varys:latest 250424072945.dkr.ecr.us-east-1.amazonaws.com/varys:$CIRCLE_TAG
      - docker push 250424072945.dkr.ecr.us-east-1.amazonaws.com/varys:$CIRCLE_TAG
      - bundle exec bin/notify_build.rb
