version: '2'
services:
  db:
    image: mysql:5.6
    ports:
      - "3307:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
  dev_server:
    build: .
    working_dir: /varys/frontend
    command: bash -c "yarn install --production=false && yarn start"
    volumes:
      - ~/.aws:/root/.aws
      - ~/.aws:/.aws
      - ./deploy_keys:/root/.ssh
      - ./:/varys
      - ./.irbrc:/root/.irbrc
    environment:
      - DEV_SERVER_PROXY=http://varys:3000
    ports:
      - "8000:8000"
    depends_on:
      - varys
  varys:
    build: .
    command: bundle exec unicorn_rails -c config/unicorn.rb
    volumes:
      - ~/.aws:/root/.aws
      - ~/.aws:/.aws
      - ./deploy_keys:/root/.ssh
      - ./:/varys
      - ./.irbrc:/root/.irbrc
    ports:
      - "3000:3000"
    env_file:
      - ./.default_env
    environment:
      - RAILS_ENV=production
      - RAILS_LOG_TO_STDOUT=true
      - SES_USER=AKIAIG5D3R545XUMDUAQ
      - RESTFORCE_SECURITY_TOKEN=tZ2A3mEmKhxjWdP98HcoaUGB
      - REGIONAL_PROXY_PASSWORD=87e50e6eb67d7
      - SCREENSHOTLAYER_SECRET_KEYWORD=FIZ7dQBIW0hefLfNCZEU5SFZeI3qS
      - MIGHTYBIT_API_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE0OTAyMjY3MzcsInZlcnNpb24iOiIyMDE3LTAzLTAzIiwianRpIjoiMzg1NjRkYTdhYTk3NDJmY2FkYWYyOGJhYjhhYzlkM2UiLCJhY2NvdW50X2lkIjoidmFyeXMiLCJzdGF0ZW1lbnRzIjpbeyJhY3Rpb24iOlsiaHR0cDpnZXQiLCJodHRwOnB1dCJdLCJyZXNvdXJjZSI6Im1yaTptd3M6ZGlzY292ZXJ5LyoiLCJlZmZlY3QiOiJhbGxvdyJ9XX0.AUWaWI3t8PT1Ii7LlhNUUQT0VE9Ai67ntu4XdRkZPok
      - VARYS_DATABASE_PASSWORD=b4820927eea6323272d99d60ba84d4be
      - PAPERCLIP_HASH_SECRET=17013fc47ea5c5bd4e36480f99fe0555938207626969ef44a4e513db8f0f6e3cb33213be7cc6e7bdfb3391e85b4c5bc075d3d417842c54e90bbef1716ceaaea1
      - API_AMPLITUDE_KEY=471a89b7f1bb5c3dce195805ed989215
      - MIGHTYQUERY_AUTH_TOKEN_GENERATION_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1MTk4NTE3MTUsInZlcnNpb24iOiIyMDE3LTAzLTAzIiwianRpIjoiMGQxODIyNGI4ZDgyNGE0YmFkY2U3YzY4OTA1ZjQ2NjEiLCJhY2NvdW50X2lkIjoidmFyeXMtc3lzdGVtIiwic3RhdGVtZW50cyI6W3siYWN0aW9uIjpbIm1pZ2h0eXF1ZXJ5OmNyZWF0ZV9hdXRoX3Rva2VuIl0sInJlc291cmNlIjoibXJpOm13czptaWdodHlxdWVyeS9hdXRoL3Rva2VuIiwiZWZmZWN0IjoiYWxsb3cifV19.Fen3gH6CjfSnFaAePexOxDwbVjmBDF8o6KECLZokNkE
      - CLEARBIT_KEY=sk_229daf10e05c493613aa2159649d03b4
      - BUGSNAG_API_KEY=5aad04b2b939ad3a21ab01bb1c35d411
      - AWS_PRESIGNER_SECRET_ACCESS_KEY=vlqCQjT7OPkVf8Z+Q3jhGURA+BGgfbsibojpZx/S
      - VARYS_DATABASE_HOST=production-db.ms-internal.com.
      - VARYS_DATABASE_NAME=
      - ELASTICSEARCH_PORT=9243
      - REGIONAL_PROXY_USER=mightysignal
      - MS_FEEDS_REDIS_DSN=redis://01.feeds.redis.ms-internal.com:6379/0
      - HOT_STORE_REDIS_PORT=6379
      - SES_SECRET=Aq3mOcSBWY3wqr9uonutXqit4Hu5QPbx90gNnJ5fCrTw
      - SIDEKIQ_UI_USERNAME=admin
      - HOT_STORE_REDIS_MAX_CONNECTIONS=1
      - MS_FEEDS_TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE1MzExNzU5ODksInZlcnNpb24iOiIyMDE3LTAzLTAzIiwianRpIjoiZjIxNjMxMmI1YWY0NGY5Y2I5MzUwMDhmYTZmMWVjMjgiLCJhY2NvdW50X2lkIjoibXJpOm13czppYW06dmFyeXMtMTp1c2VyL2luZnJhc3RydWN0dXJlQG1pZ2h0eXNpZ25hbC5jb20iLCJzdGF0ZW1lbnRzIjpbeyJhY3Rpb24iOlsicGFydG5lcl9mZWVkOmxpc3QiXSwicmVzb3VyY2UiOlsibXJpOm13czpwYXJ0bmVyX2ZlZWQvKiJdLCJlZmZlY3QiOiJhbGxvdyJ9LHsiYWN0aW9uIjpbInBhcnRuZXJfZmVlZDpnZXQiXSwicmVzb3VyY2UiOlsibXJpOm13czpwYXJ0bmVyX2ZlZWQvKiJdLCJlZmZlY3QiOiJhbGxvdyJ9XX0.xSds_Ag3bPQk-edp5BqmaCRajyzC7V3tj1VP8jYHpRg
      - EPF_PASSWORD=42413e32cb2759c0e96c9b3cb154c8e2
      - MIGHTYSIGNAL_API_TOKEN=a63c8f2e7d280935c9868d2316475686
      - RECAPTCHA_SECRET_KEY=6Ld6wxEUAAAAAG_J9dJBx5my4TR7o-0or5V1yK41
      - HOT_STORE_REDIS_URL=01.hot-store.ms-internal.com
      - ELASTICSEARCH_USER=admin
      - BUTTER_TOKEN=b8ecb90e183a7a7309856e7b7288633f2fc8e835
      - MIXPANEL_API_KEY=6a96c6c2b8cb2ad6de06ad54957b2f2a
      - TWITTER_BOT_ACCESS_TOKEN_SECRET=6nW7MRZ9Jv7q6UdofZpuxjMjlgvDpycBYyWWUJMl2Qyis
      - GMAIL_SMTP_PASSWORD='Yb]fVjNRVAZdpE8pHM9,y9nYw'
      - GOOGLE_AUTH_CLIENT_SECRET=alyqEz-2j7Edf1_fUQpC3K1j
      - REDSHIFT_DATABASE_PASSWORD=UnZ5E4WQDoToLw3DfzhIJF2Hy7tfCJBk
      - GOOGLE_URL_SHORTENER_KEY=AIzaSyAtGLt_HFtLpj0yeKT59kaP9YZpsXycYAw
      - REDSHIFT_DATABASE_PORT=5439
      - API_BILLING_LOG_STREAM=varys_api_billing
      - EPF_USERNAME=epfuser99894
      - TWITTER_BOT_API_SECRET=1RreoRcjxJSuk1WhujHZSKGF2kXYlfyPuwm3s72cFpKpIXlmMy
      - ELASTICSEARCH_PASSWORD=gv6shgdsdqji65e90n
      - S3_SECRET_ACCESS_KEY=clA7XIudbmbLJf5rniRYs2nyo/2ymnwJwgiQcPwb
      - SES_PORT=587
      - RESTFORCE_USERNAME=jasonlew@mightysignal.com
      - SECRET_KEY_BASE=69fb41bd51411033a2bb72fdb2dc15e4840c9812757c3116eb880920a039dff3005ebbefd0a5170f151e5e202137b13bfdc029240c763a6427ad18264e738a67EOF
      - REDSHIFT_DATABASE_HOST=production-0.cwlsv2xsvhws.us-east-1.redshift.amazonaws.com
      - REDSHIFT_DATABASE_USER=root
      - SALESFORCE_KMS_KEY_ID=arn:aws:kms:us-east-1:250424072945:key/8e51a589-9f56-44ef-a45c-522482b08703
      - MICRO_PROXY_PORT=8888
      - VARYS_REDIS_PORT=6379
      - SCREENSHOTLAYER_ACCESS_KEY=648cf3119971729d91840abfb35793fd
      - RECAPTCHA_SITE_KEY=6Ld6wxEUAAAAAO1WYQKDTx6hvlO0_eFMFNQWgInj
      - SES_HOST=email-smtp.us-east-1.amazonaws.com
      - RESTFORCE_PASSWORD=Welcome@2
      - VARYS_REDIS_URL=01.redis.ms-internal.com
      - ELASTICSEARCH_URL=https://57ee73786e08205571d6e29709308c9c.us-east-1.aws.found.io
      - REDIS_DISCOVERY_URL=01.volatile.redis.ms-internal.com
      - RESTFORCE_CLIENT_ID=3MVG9fMtCkV6eLhcIlf3UM3DhI0qHjleFYx1eiGwILdwEf8djU26Vnqjd3mu1Kxs0Z258R99eC0sfRJHG548g
      - LINKEDIN_AUTH_CLIENT_SECRET=eidrZL6asyWvONuh
      - SALESFORCE_AUTH_CLIENT_SECRET=5574165875659959133
      - MIXPANEL_API_SECRET=f7d1ee068ddf3d2366d0ed89fe0618dc
      - MICRO_PROXY_URL=micro-proxies.ms-internal.com
      - S3_ACCESS_KEY_ID=AKIAINN6KCSAKXCAZLUQ
      - AWS_PRESIGNER_ACCESS_KEY_ID=AKIAILUMKLAA6322PK2Q
      - REDIS_DISCOVERY_PORT=6379
      - VARYS_DATABASE_USER=root
      - GOOGLE_TRANSLATE_API_KEY=AIzaSyAo1BImNU-zMFzNX41S_-_ZuWbkrDTQYk0
      - RESTFORCE_CLIENT_SECRET=6384884061761347258
      - SIDEKIQ_UI_PASSWORD=gv6shgdsdqji65e90n
    depends_on:
      - db
      - redis
      - elasticsearch
      - proxy
      - redshift
  redis:
    image: redis:2.8
    expose:
      - "6379"
  nginx:
    build: .
    ports:
      - "8888:80"
    command: nginx -g "daemon off;"
    volumes:
      - ./container_assets/sites-available:/etc/nginx/sites-available/default
    depends_on:
      - varys
  sidekiq:
    build: .
    command: bundle exec sidekiq -C config/sidekiq.yml
    volumes:
      - ~/.aws:/root/.aws
      - ~/.aws:/.aws
      - ./:/varys
    environment:
      - RAILS_ENVIRONMENT=development
      - VARYS_DATABASE_PASSWORD=root
      - VARYS_DATABASE_USER=root
      - VARYS_DATABASE_HOST=db
      - USER=${USER}
      - VARYS_STAGE=local
      - VARYS_REDIS_URL=redis
      - VARYS_REDIS_PORT=6379
      - SECRET_KEY_BASE=ba97723a703ca6aeeb1eef8ec869102134ca81f0d7e50271c8672161551ceb82931e68e71cad7bfdc8a62d37e4414aea04dc529df8fc9711ee5d2302d3ed2e43
      - PAPERCLIP_HASH_SECRET=3cfc4f8be8a7bcf26c4e38932664891c349eebfa1fc341e061fdfabdd11fc035325d5f7b4ec51cee6776cb867859d0913452beb1d653190891fe3765d76adb99
      - SIDEKIQ_QUEUES=noop
      - SIDEKIQ_CONCURRENCY=1
      - ELASTICSEARCH_URL=elasticsearch
      - ELASTICSEARCH_PORT=9200
      - S3_ACCESS_KEY_ID=dummy
      - S3_SECRET_ACCESS_KEY=dummy
      - REGIONAL_PROXY_USER=dummy
      - REGIONAL_PROXY_PASSWORD=dummy
      - RECAPTCHA_SITE_KEY=dummy
      - RECAPTCHA_SECRET_KEY=dummy
      - REDSHIFT_DATABASE_USER=root
      - REDSHIFT_DATABASE_PASSWORD=root
      - REDSHIFT_DATABASE_HOST=redshift
      - REDSHIFT_DATABASE_PORT=5432
      - HOT_STORE_REDIS_URL=redis
      - HOT_STORE_REDIS_PORT=6379
      - HOT_STORE_REDIS_MAX_CONNECTIONS=6
    depends_on:
      - db
      - redis
      - elasticsearch
      - proxy
      - redshift
  elasticsearch:
    image: elasticsearch:2.3
    ports:
      - "9200:9200"
  proxy:
    image: 250424072945.dkr.ecr.us-east-1.amazonaws.com/squid:latest
  redshift:
    image: postgres:9.6 # just use any postgres
    environment:
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=root
      - POSTGRES_DB=data
    ports:
      - "5439:5432"
